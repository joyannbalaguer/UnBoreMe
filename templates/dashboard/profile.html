{% extends "base.html" %}

{% block title %}Edit Profile - GameHub{% endblock %}

{% block content %}
<div class="container">
    <div class="profile-container">
        <div class="profile-header">
            <h1 class="neon-text">Edit Profile</h1>
            <p>Update your personal information</p>
        </div>

        <div class="profile-content glass">
            <!-- PROFILE EDIT FORM (posts to edit_profile) -->
            <form method="POST" action="{{ url_for('dashboard.edit_profile') }}" class="profile-form" id="profileForm">
                <div class="form-section">
                    <h3>Personal Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstname">First Name <span class="required">*</span></label>
                            <input 
                                type="text" 
                                id="firstname" 
                                name="firstname" 
                                class="form-control glass" 
                                value="{{ user.firstname }}"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label for="middlename">Middle Name</label>
                            <input 
                                type="text" 
                                id="middlename" 
                                name="middlename" 
                                class="form-control glass" 
                                value="{{ user.middlename or '' }}"
                            >
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="lastname">Last Name <span class="required">*</span></label>
                        <input 
                            type="text" 
                            id="lastname" 
                            name="lastname" 
                            class="form-control glass" 
                            value="{{ user.lastname }}"
                            required
                        >
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="birthday">Birthday</label>
                            <input 
                                type="date" 
                                id="birthday" 
                                name="birthday" 
                                class="form-control glass" 
                                value="{{ user.birthday or '' }}"
                            >
                        </div>

                        <div class="form-group">
                            <label for="contact">Contact Number</label>
                            <input 
                                type="tel" 
                                id="contact" 
                                name="contact" 
                                class="form-control glass" 
                                value="{{ user.contact or '' }}"
                                placeholder="+63 912 345 6789"
                            >
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Account Information</h3>
                    
                    <div class="form-group">
                        <label>Username</label>
                        <input 
                            type="text" 
                            class="form-control glass" 
                            value="{{ user.username }}"
                            disabled
                        >
                        <small>Username cannot be changed</small>
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input 
                            type="email" 
                            class="form-control glass" 
                            value="{{ user.email }}"
                            disabled
                        >
                        <small>Email cannot be changed</small>
                    </div>
                </div>

                <div class="form-actions">
                    <!-- Changed: Save button now opens confirm modal -->
                    <button type="button" id="openConfirmProfileModal" class="btn btn-primary glow">Save Changes</button>
                    <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>

            <!-- Change Password Section (INLINE FORM) -->
            <div class="password-section" style="margin-top:2rem;">
                <h3>Change Password</h3>
                <form method="POST" action="{{ url_for('dashboard.change_password') }}" class="password-form" id="passwordForm">
                    <div class="form-group">
                        <label for="current_password">Current Password</label>
                        <input 
                            type="password" 
                            id="current_password" 
                            name="current_password" 
                            class="form-control glass" 
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="new_password">New Password</label>
                        <input 
                            type="password" 
                            id="new_password" 
                            name="new_password" 
                            class="form-control glass" 
                            minlength="8"
                            required
                        >
                        <small>Minimum 8 characters</small>
                    </div>

                    <div class="form-group">
                        <label for="confirm_new_password">Confirm New Password</label>
                        <input 
                            type="password" 
                            id="confirm_new_password" 
                            name="confirm_new_password" 
                            class="form-control glass" 
                            minlength="8"
                            required
                        >
                    </div>

                    <!-- NOTE: This button opens the confirmation modal instead of submitting directly -->
                    <button type="button" id="openChangePasswordModal" class="btn btn-primary">Change Password</button>
                </form>
            </div>
        </div>
    </div>
</div>

{# Server can set show_password_modal=True when rendering after a failed POST.
   That will cause the modal to auto-open so the user sees the flash message. #}
{% if show_password_modal %}
<script>window.SHOULD_OPEN_PASSWORD_MODAL = true;</script>
{% endif %}

<!-- Confirmation Modal for Profile Save -->
<div id="confirmProfileModal" class="modal-overlay" style="display:none;">
    <div class="modal glass" role="dialog" aria-modal="true" aria-labelledby="confirmProfileTitle" style="max-width:480px;">
        <button type="button" class="modal-close" id="closeConfirmProfile" style="float:right; background:transparent; border:0; font-size:22px; color:#fff;">×</button>
        <h2 id="confirmProfileTitle" style="color:#00f8ff; margin-top:0;">Confirm Changes</h2>
        <p>Are you sure you want to change your name?</p>

        <div class="modal-actions" style="margin-top:18px; display:flex; gap:10px; justify-content:flex-end;">
            <button type="button" class="btn btn-secondary" id="cancelConfirmProfile">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmSaveProfile">Yes, save changes</button>
        </div>
    </div>
</div>

<!-- Existing Confirmation Modal for Password (keeps your previous modal) -->
<div id="confirmPasswordModal" class="modal-overlay" style="display:none;">
    <div class="modal glass" role="dialog" aria-modal="true" aria-labelledby="confirmPasswordTitle" style="max-width:480px;">
        <button type="button" class="modal-close" id="closeConfirmPassword" style="float:right; background:transparent; border:0; font-size:22px; color:#fff;">×</button>
        <h2 id="confirmPasswordTitle" style="color:#00f8ff; margin-top:0;">Are you sure?</h2>
        <p>Are you sure you want to change your password? Make sure you won't forget it!</p>

        <div class="modal-actions" style="margin-top:18px; display:flex; gap:10px; justify-content:flex-end;">
            <button type="button" class="btn btn-secondary" id="cancelConfirmPassword">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirmChangePassword">Yes, change password</button>
        </div>
    </div>
</div>

<style>
/* minimal modal styles to match theme */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.65);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}
.modal {
    padding: 24px;
    border-radius: 12px;
    width: 92%;
    max-width: 520px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // ---------- Profile Save Confirmation Modal ----------
    const openProfileBtn = document.getElementById('openConfirmProfileModal');
    const profileModal = document.getElementById('confirmProfileModal');
    const closeProfileBtn = document.getElementById('closeConfirmProfile');
    const cancelProfileBtn = document.getElementById('cancelConfirmProfile');
    const confirmProfileBtn = document.getElementById('confirmSaveProfile');
    const profileForm = document.getElementById('profileForm');

    function showProfileModal() {
        if (profileModal) profileModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function hideProfileModal() {
        if (profileModal) profileModal.style.display = 'none';
        document.body.style.overflow = '';
    }

    if (openProfileBtn) {
        openProfileBtn.addEventListener('click', function () {
            if (!profileForm) { showProfileModal(); return; }
            if (!profileForm.checkValidity()) {
                profileForm.reportValidity();
                return;
            }
            showProfileModal();
        });
    }

    if (closeProfileBtn) closeProfileBtn.addEventListener('click', hideProfileModal);
    if (cancelProfileBtn) cancelProfileBtn.addEventListener('click', hideProfileModal);

    if (confirmProfileBtn) {
        confirmProfileBtn.addEventListener('click', function () {
            hideProfileModal();
            if (profileForm) profileForm.submit();
        });
    }

    // ---------- Password Confirmation Modal (existing) ----------
    // Password validation
    const newPwd = document.getElementById('new_password');
    const confirmPwd = document.getElementById('confirm_new_password');

    function validatePasswordMatch() {
        if (!newPwd || !confirmPwd) return;
        if (newPwd.value !== confirmPwd.value) {
            confirmPwd.setCustomValidity('Passwords do not match');
        } else {
            confirmPwd.setCustomValidity('');
        }
    }

    if (newPwd) newPwd.addEventListener('input', validatePasswordMatch);
    if (confirmPwd) confirmPwd.addEventListener('input', validatePasswordMatch);

    const openPwdBtn = document.getElementById('openChangePasswordModal');
    const pwdModal = document.getElementById('confirmPasswordModal');
    const closePwdBtn = document.getElementById('closeConfirmPassword');
    const cancelPwdBtn = document.getElementById('cancelConfirmPassword');
    const confirmPwdBtn = document.getElementById('confirmChangePassword');
    const passwordForm = document.getElementById('passwordForm');

    // Ensure password modal hidden initially
    if (pwdModal) pwdModal.style.display = 'none';

    function showPwdModal() {
        if (pwdModal) pwdModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function hidePwdModal() {
        if (pwdModal) pwdModal.style.display = 'none';
        document.body.style.overflow = '';
    }

    if (openPwdBtn) openPwdBtn.addEventListener('click', function () {
        if (!passwordForm) { showPwdModal(); return; }
        if (passwordForm.checkValidity()) {
            showPwdModal();
        } else {
            passwordForm.reportValidity();
        }
    });

    if (closePwdBtn) closePwdBtn.addEventListener('click', hidePwdModal);
    if (cancelPwdBtn) cancelPwdBtn.addEventListener('click', hidePwdModal);

    if (confirmPwdBtn) confirmPwdBtn.addEventListener('click', function () {
        if (passwordForm) {
            hidePwdModal();
            passwordForm.submit();
        }
    });

    // Close any modal with Escape key
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            hideProfileModal();
            hidePwdModal();
        }
    });

    // Optional: auto-open password modal if server requested it
    try {
        if (window.SHOULD_OPEN_PASSWORD_MODAL === true) {
            setTimeout(function(){ if (passwordForm) showPwdModal(); }, 80);
        }
    } catch (e) {
        // ignore
    }
});
</script>
{% endblock %}

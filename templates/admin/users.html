{# app/templates/admin/user.html #}
{% extends "base.html" %}

{% block title %}Manage Users - UnBoreMe{% endblock %}

{% block content %}

<style>
.actions-column {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-end;
}
.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 14px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    border: none;
    min-width: 90px;
    justify-content: center;
}
.edit-btn { background:#ffb423; color:#000; }
.delete-btn { background:#ff2e2e; color:#fff; }

.status-badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 700;
}
.status-active { background:#16a34a; color:white; }
.status-inactive { background:#eab308; color:white; }
.status-badge-link { cursor:pointer; text-decoration:none; color:inherit; }

@media(max-width:900px){
    .actions-column { flex-direction:row; justify-content:center; }
}
.table-actions {
    display:flex;
    gap:8px;
    justify-content:flex-end;
    align-items:center;
}

/* search input small tweak */
#userSearch {
    max-width: 360px;
    display: inline-block;
}
#searchControls {
    display:flex;
    gap:10px;
    align-items:center;
}
#searchClear {
    cursor:pointer;
    background: transparent;
    border: none;
    color: #fff;
    font-weight: 700;
    padding: 4px 8px;
}
#searchCount {
    color: #cbd5e1;
    font-size: 0.95rem;
}
</style>

<div class="container mt-4">

    <h1 class="display-5"><i class="fas fa-users"></i> Manage Users</h1>
    <p class="lead">View and manage all registered users</p>

    <div class="mb-3">
        <a href="{{ url_for('admin.create_user') }}" class="btn btn-success">
            <i class="fas fa-user-plus"></i> Create New User
        </a>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5><i class="fas fa-list"></i> All Users</h5>
        </div>

        <div class="card-body">

            <!-- SEARCH BAR + CONTROLS -->
            <div class="row mb-3">
                <div class="col-md-6 d-flex align-items-center" id="searchControls">
                    <input id="userSearch" type="text" class="form-control" placeholder="Search users... (id, username, email, name, active, admin, 2025-12-07)">
                    <button id="searchClear" title="Clear search" aria-label="Clear search">âœ•</button>
                    <div id="searchCount" aria-live="polite"></div>
                </div>
            </div>

            {% if users %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th style="width:220px; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>

                        {% for user in users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td><strong>{{ user.username }}</strong></td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.firstname }} {{ user.lastname }}</td>

                            <td>
                                {% if user.role == 'admin' %}
                                    <span class="badge bg-danger">Admin</span>
                                {% else %}
                                    <span class="badge bg-secondary">User</span>
                                {% endif %}
                            </td>

                            <td>
                                {% if user.is_active %}
                                    <a class="status-badge-link" href="{{ url_for('admin.deactivate_user', user_id=user.id) }}" title="Click to deactivate">
                                        <span class="status-badge status-active">Active</span>
                                    </a>
                                {% else %}
                                    <a class="status-badge-link" href="{{ url_for('admin.activate_user', user_id=user.id) }}" title="Click to activate">
                                        <span class="status-badge status-inactive">Inactive</span>
                                    </a>
                                {% endif %}
                            </td>

                            <td><small>{{ user.created_at|date }}</small></td>

                            <td class="actions-column">
                                <div class="table-actions" style="width:100%; justify-content:flex-end;">

                                    <a href="{{ url_for('admin.view_user', user_id=user.id) }}"
                                       class="action-btn edit-btn" title="View">
                                        <i class="fas fa-eye"></i> View
                                    </a>

                                    <a href="{{ url_for('admin.edit_user', user_id=user.id) }}"
                                       class="action-btn edit-btn" title="Edit">
                                       <i class="fas fa-edit"></i> Edit
                                    </a>

                                    {% if user.id != session.user_id %}
                                    <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}"
                                          class="deleteUserForm" style="display:inline;">
                                        <button type="button" class="action-btn delete-btn deleteUserBtn">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                    {% else %}
                                    <button class="action-btn delete-btn" disabled title="Cannot delete yourself">
                                        <i class="fas fa-ban"></i> Can't Delete Self
                                    </button>
                                    {% endif %}

                                </div>
                            </td>
                        </tr>
                        {% endfor %}

                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted">No users found</p>
            {% endif %}
        </div>
    </div>

</div>

<!-- SweetAlert2 (include once site-wide; safe to leave if not present elsewhere) -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Delete confirmation
    document.querySelectorAll(".deleteUserBtn").forEach(btn => {
        btn.addEventListener("click", function (e) {
            const form = this.closest(".deleteUserForm");
            Swal.fire({
                title: "Delete User?",
                text: "Are you sure you want to delete this user? This action cannot be undone.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, delete",
                cancelButtonText: "Cancel",
                confirmButtonColor: "#d9534f",
                cancelButtonColor: "#6c757d",
                background: "#12121a",
                color: "#ffffff",
                customClass: {
                    popup: 'swal2-popup-dark'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                
                    form.submit();
                }
            });
        });
    });

    // Enhanced client-side search/filter
    const searchInput = document.getElementById('userSearch');
    const clearBtn = document.getElementById('searchClear');
    const countEl = document.getElementById('searchCount');
    const rows = Array.from(document.querySelectorAll('table tbody tr'));
    const total = rows.length;

    function updateCount(visible) {
        countEl.textContent = `Showing ${visible} of ${total}`;
    }

    function normalize(s) {
        return (s || '').toString().toLowerCase();
    }

    function rowMatchesQuery(row, q) {
        if (!q) return true;
        const text = normalize(row.innerText);

        // exact status/role keywords
        if (q === 'active') return text.includes('active');
        if (q === 'inactive') return text.includes('inactive');
        if (q === 'admin') return text.includes('admin');
        if (q === 'user') {
            
            if (text.includes('admin') && !text.includes('user')) return false;
            return text.includes('user');
        }

        // date format YYYY-MM-DD
        if (/^\d{4}-\d{2}-\d{2}$/.test(q)) {
            return text.includes(q);
        }

        // fallback: substring match
        return text.includes(q);
    }

    function runFilter() {
        const q = normalize(searchInput.value.trim());
        let visible = 0;
        rows.forEach(r => {
            const show = rowMatchesQuery(r, q);
            r.style.display = show ? '' : 'none';
            if (show) visible++;
        });
        updateCount(visible);
    }

    if (searchInput) {
        // initial count
        updateCount(total);

        searchInput.addEventListener('input', runFilter);

        clearBtn.addEventListener('click', function () {
            searchInput.value = '';
            runFilter();
            searchInput.focus();
        });

        // allow pressing Enter to focus next row (UX nicety)
        searchInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });
    }
});
</script>

<style>
/*SweetAlert styling */
.swal2-popup-dark {
    background: #12121a !important;
    color: #e9eef6 !important;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
.swal2-container { z-index: 99999 !important; }
</style>

{% endblock %}
